{% extends "base.html" %}

{% block title %}Meal Plan | KitchenClip{% endblock %}

{% block extra_head %}
<!-- Force Widescreen Override -->
<link rel="stylesheet" href="{% static 'css/meal_plan.css' %}">
{% endblock %}

{% block content %}
<div id="sidebar-handle">Recipes & Ideas</div>
<div id="overlay-backdrop"></div>

<div id="sidebar-overlay">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-black text-[#194769]">Library</h3>
        <button id="close-sidebar" class="text-2xl text-gray-300 hover:text-gray-600">&times;</button>
    </div>

    <div class="relative mb-4">
        <input type="text" id="recipe-search" placeholder="Quick search..."
            class="w-full px-4 py-2.5 bg-gray-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-[#194769]">
    </div>

    <button id="add-manual"
        class="w-full py-3 mb-6 bg-[#194769] hover:bg-[#5B8E7D] text-white font-black rounded-xl text-xs shadow-md">
        + Custom Meal
    </button>

    <div id="sidebar-results" class="flex-1 overflow-y-auto pr-2 space-y-6">
        <div>
            <h4 class="sidebar-header" style="margin-top:0">My Recipes</h4>
            <div class="space-y-2">
                {% for recipe in saved_recipes|slice:":3" %}
                <div class="recipe-card p-2 bg-gray-50 rounded-xl flex items-center gap-3 cursor-grab hover:bg-white border border-transparent hover:border-gray-100 transition-all group"
                    draggable="true" data-id="{{ recipe.id }}" data-title="{{ recipe.title }}"
                    data-image="{{ recipe.image_url|default:'' }}">
                    {% if recipe.image_url %}
                    <img src="{{ recipe.image_url }}" class="w-10 h-10 rounded-lg object-cover">
                    {% else %}
                    <div
                        class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center text-[10px] font-black">
                        {{ recipe.title|slice:":1" }}</div>
                    {% endif %}
                    <span class="font-bold text-gray-700 text-xs truncate">{{ recipe.title }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        <div>
            <h4 class="sidebar-header">Future Ideas</h4>
            <div class="space-y-2">
                {% for recipe in future_recipes|slice:":3" %}
                <div class="recipe-card p-2 bg-gray-50 rounded-xl flex items-center gap-3 cursor-grab hover:bg-white border border-transparent hover:border-gray-100 transition-all group"
                    draggable="true" data-id="{{ recipe.id }}" data-title="{{ recipe.title }}"
                    data-image="{{ recipe.image_url|default:'' }}">
                    {% if recipe.image_url %}
                    <img src="{{ recipe.image_url }}" class="w-10 h-10 rounded-lg object-cover">
                    {% else %}
                    <div
                        class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center text-[10px] font-black">
                        {{ recipe.title|slice:":1" }}</div>
                    {% endif %}
                    <span class="font-bold text-gray-700 text-xs truncate">{{ recipe.title }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="p-8">
    <h1 class="text-3xl font-black text-[#194769] mb-10">Meal Planner</h1>

    {% for week in weeks %}
    <div class="mb-12">
        <div class="flex items-center gap-4 mb-6">
            <span class="h-px bg-gray-200 flex-1"></span>
            <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">
                {% if forloop.first %}Current Week{% else %}Next Week{% endif %}
            </span>
            <span class="h-px bg-gray-200 flex-1"></span>
        </div>

        <div class="week-grid">
            {% for day in week %}
            <div
                class="bg-white rounded-2xl border {% if day.is_today %}border-[#194769] ring-4 ring-[#194769] ring-opacity-10{% else %}border-gray-100{% endif %} overflow-hidden shadow-sm flex flex-col">
                <div
                    class="{% if day.is_today %}bg-[#194769] text-white{% else %}bg-gray-50 text-gray-500{% endif %} py-2 px-3 text-center border-b border-gray-100">
                    <div class="text-[10px] font-black">{{ day.day_name|upper }}</div>
                    <div class="text-[8px] font-bold opacity-60">{{ day.date|date:"M j" }}</div>
                </div>

                <div class="p-2 space-y-3 flex-1">
                    <!-- Lunch -->
                    <div>
                        <div class="text-[7px] font-black text-gray-300 uppercase tracking-tighter mb-1">Lunch</div>
                        <div class="meal-slot" data-date="{{ day.date|date:'Y-m-d' }}" data-type="LUNCH">
                            {% if day.lunch %}
                            <div class="draggable-meal bg-white border border-gray-100 shadow-sm p-2 rounded-xl relative group"
                                draggable="true" data-recipe-id="{{ day.lunch.recipe.id|default:'' }}"
                                data-custom="{{ day.lunch.custom_meal }}">
                                {% if day.lunch.recipe.image_url %}
                                <img src="{{ day.lunch.recipe.image_url }}"
                                    class="w-full h-12 object-cover rounded-lg mb-1">
                                {% endif %}
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-gray-800 leading-tight">
                                        {% if day.lunch.recipe %}{{ day.lunch.recipe.title }}{% else %}{{
                                        day.lunch.custom_meal }}{% endif %}
                                    </span>
                                    <button
                                        class="remove-meal opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 font-bold">&times;</button>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Dinner -->
                    <div>
                        <div class="text-[7px] font-black text-gray-300 uppercase tracking-tighter mb-1">Dinner</div>
                        <div class="meal-slot" data-date="{{ day.date|date:'Y-m-d' }}" data-type="DINNER">
                            {% if day.dinner %}
                            <div class="draggable-meal bg-white border border-gray-100 shadow-sm p-2 rounded-xl relative group"
                                draggable="true" data-recipe-id="{{ day.dinner.recipe.id|default:'' }}"
                                data-custom="{{ day.dinner.custom_meal }}">
                                {% if day.dinner.recipe.image_url %}
                                <img src="{{ day.dinner.recipe.image_url }}"
                                    class="w-full h-12 object-cover rounded-lg mb-1">
                                {% endif %}
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-gray-800 leading-tight">
                                        {% if day.dinner.recipe %}{{ day.dinner.recipe.title }}{% else %}{{
                                        day.dinner.custom_meal }}{% endif %}
                                    </span>
                                    <button
                                        class="remove-meal opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 font-bold">&times;</button>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Manual Modal -->
<div id="manual-modal"
    class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[3000] flex items-center justify-center">
    <div class="bg-white p-8 rounded-3xl w-80 shadow-2xl">
        <h4 class="text-xl font-black mb-4">Add Meal</h4>
        <input type="text" id="manual-text" class="w-full p-3 bg-gray-50 rounded-xl mb-6 font-bold"
            placeholder="Pizza night?">
        <div class="flex gap-2">
            <button id="modal-cancel" class="flex-1 py-2 text-gray-400 font-bold">Cancel</button>
            <button id="modal-save" class="flex-1 py-2 bg-[#194769] text-white rounded-xl font-bold">Add</button>
        </div>
    </div>
</div>

</div>

<!-- Recipe Detail Modal -->
<div id="recipe-modal"
    class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-[4000] flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl w-full max-w-3xl max-h-[90vh] shadow-2xl flex flex-col overflow-hidden relative">
        <button id="close-recipe-modal"
            class="absolute top-4 right-4 z-10 bg-white/80 hover:bg-white rounded-full p-2 text-gray-500 hover:text-gray-800 transition-colors shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <div id="recipe-modal-content" class="overflow-y-auto w-full h-full p-4 relative">
            <div class="flex justify-center items-center h-40">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#194769]"></div>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>
{% endblock %}

{% block javascript %}
<script>
    window.CSRF_TOKEN = '{{ csrf_token }}';
</script>
<script src="{% static 'js/meal_plan.js' %}"></script>
{% endblock %}